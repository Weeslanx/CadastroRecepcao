<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Entradas</title>
    <link rel="stylesheet" href="/styles.css">

 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
	
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
	 <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
	




</head>
<body>



    <div id="sidebar-container"></div> 



    <div id="customAlert" class="custom-alert">
        <div class="custom-alert-content">
            <p id="customAlertMessage">Mensagem</p>
            <button id="alertOk" class="btn-confirm">OK</button>
        </div>
    </div>



    
       <div class = "menu"> 
       
        <h1> Registro de Correios</h1>
        	
        	
								   <button class="add-visit" id="add-correios-btn">
                                    <i class="fas fa-plus"></i> Adicionar Correios	
								   </button>

						           
                                    
                                    <div class="logo-container">
                                        <img src="/images/logo3.png" alt="Logo" class="logo-img">
                                    </div>


                                    <button class="btn_dowload-correios" onclick="exportVisibleToCSV()">
                                        <i class="fas fa-download"></i>
                                    </button>
       </div>
     
       
    
    
       <div class="main-content">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Pesquisar" onkeyup="filter()">
        </div>

        

        <h2>Correios Cadastrados</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Funcionário</th>
                    <th>Cartão</th>
                    <th>Horário</th>
                    <th>Código Postal</th>
                    <th>Destinatário</th>
                    <th>Entregador</th>
                    <th>Serviço</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="correio : ${Correios}" th:attr="data-id=${correio.id}">
                    <td th:text="${correio.id}"></td>
                    <td th:text="${correio.funcionario}"></td>
                    <td th:text="${correio.setor != null ? correio.setor.nome : 'Sem setor'}"></td>

                    <td th:text="${#temporals.format(correio.horario, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${correio.codigoPostal}"></td>
                    <td th:text="${correio.destinatario}"></td>
                    <td th:text="${correio.entregador}"></td>
                    <td th:text="${correio.servico}"></td>
                </tr>
            </tbody>
            
        </table>
    </div>


        
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Detalhes do Registro</h2>
            <p><strong>ID:</strong> <span id="modal-id"></span></p>
            <p><strong>Funcionário:</strong> <span id="modal-funcionario"></span></p>
            <p><strong>Setor:</strong> <span id="modal-setor"></span></p>
            <p><strong>Horário:</strong> <span id="modal-horario"></span></p>
            <p><strong>Código Postal:</strong> <span id="modal-codigoPostal"></span></p>
            <p><strong>Destinatário:</strong> <span id="modal-destinatario"></span></p>
            <p><strong>Entregador:</strong> <span id="modal-entregador"></span></p>
            <p><strong>Serviço:</strong> <span id="modal-servico"></span></p>
            <div class="modal-actions">
                <button id="edit-button">Editar</button>
                <button id="delete-button">Excluir</button>
            </div>
        </div>
    </div>

    
    <div class="sidebar-right" id="sidebar-funcionario" style="display: none;z-index: 1001;">
                            <button class="close-btn" onclick="toggleDropdown('sidebar-funcionario')">&times;</button>
                            <h2>Cadastrar Funcionário</h2>
                            <form id="formFuncionario">
                                <label for="primeiroNome">Primeiro Nome</label>
                                <input type="text" id="primeiroNome" name="primeiroNome" required />
                        
                                <label for="ultimoNome">Último Nome</label>
                                <input type="text" id="ultimoNome" name="ultimoNome" required />
                        
                                <label for="setor">Setor</label>
                                <select id="setorlist" name="setorId" required>
                                    <option value="" disabled selected>Selecione um setor</option>
                                </select>
                        
                                <button class="btn" type="submit">Salvar</button>
                            </form>
                        </div>
            

    <div class="sidebar-right" id="sidebar-Correios" style="display: none;">
        <button class="close-btn" id="close-correios-btn">&times;</button>
        <h2>Cadastrar Correios</h2>
        <form action="/correios/cadastrar" method="POST">

            <label for="funcionario">Funcionário</label>
            <select id="funcionario" name="funcionario" class="select2" >
                <option value="" disabled selected>Selecione um funcionário</option>
            </select>

            <br><br>
            <label for="setor">N° Cartão</label>
            <select id="setor" name="setor" required>
                <option value="">Selecione um setor</option>
            </select>

            <label for="horario">Horário</label>
            <input type="datetime-local" id="horario" name="horario" required>

            <label for="codigoPostal">Código Postal</label>
            <input type="text" id="codigoPostal" name="codigoPostal" required>

            <label for="destinatario">Destinatário</label>
            <input type="text" id="destinatario" name="destinatario" required>

            <label for="entregador">Entragador</label>
            <select id="entregador" name="entregador" required>
                <option value="Valmir">VALMIR</option>
            </select>
            <label for="servico">Serviço</label>
            <select id="servico" name="servico" required>
                <option value="SEDEX">SEDEX</option>
                <option value="PAC">PAC</option>
            </select>

            <button class="btn"  type="submit">Salvar</button>
        </form>
    </div>
						
						
						
						
						
						  
			    
<script>

    // Inicializa a função ao carregar a página
document.addEventListener('DOMContentLoaded', function(){
 configurarFormularioFuncionario();
 populateFuncionariosSelect()

});


$(document).ready(function() {
            $("#sidebar-container").load("/fragment/sidebar.html");
        });

function customAlert(message) {
    const modal = document.getElementById('customAlert');
    const messageElement = document.getElementById('customAlertMessage');
    const okButton = document.getElementById('alertOk');

   
    messageElement.textContent = message;

    
    modal.style.display = 'flex';

    
    okButton.onclick = () => {
        modal.style.display = 'none';
    };
}


function customConfirm(message) {
    return new Promise((resolve) => {
        const modal = document.getElementById('customConfirm');
        const messageElement = document.getElementById('customConfirmMessage');
        const yesButton = document.getElementById('confirmYes');
        const noButton = document.getElementById('confirmNo');

        messageElement.textContent = message;


        modal.style.display = 'flex';

    
        yesButton.onclick = () => {
            modal.style.display = 'none';
            resolve(true); 
        };

        noButton.onclick = () => {
            modal.style.display = 'none'; 
            resolve(false); 
        };
    });
}

        const addVisitBtn = document.getElementById('add-correios-btn');
        const sidebarRight = document.getElementById('sidebar-right');
        const closeSidebarBtn = document.getElementById('close-correios-btn');

     
        addVisitBtn.addEventListener('click', () => {
            sidebarRight.classList.add('active');
        });

       
        closeSidebarBtn.addEventListener('click', () => {
            sidebarRight.classList.remove('active');
        });

        document.getElementById('add-correios-btn').addEventListener('click', function() {
        var sidebarRight = document.getElementById('sidebar-Correios');
        sidebarRight.style.display = 'block'; 
    });
    document.getElementById('close-correios-btn').addEventListener('click', function() {
        var sidebarRight = document.getElementById('sidebar-Correios');
        sidebarRight.style.display = 'none'; 
    });
    
    $(document).ready(function() {
    $('.select2').select2({
        placeholder: "Selecione uma opção",
        allowClear: true,
        width: 'resolve', // Ajusta o tamanho automaticamente ao container
        minimumInputLength: 1, // Exige ao menos um caractere para iniciar a busca
        language: {
            noResults: function() {
                return "Nenhuma opção encontrada";
            },
            inputTooShort: function(args) {
                return " ";
            }
        },
        matcher: function(params, data) {
            // Ignora a busca em opções vazias
            if ($.trim(params.term) === '') {
                return data;
            }

            // Faz a busca ignorando maiúsculas/minúsculas e acentos
            const term = params.term.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const text = data.text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            if (text.includes(term)) {
                return data;
            }

            // Retorna `null` se não houver correspondência
            return null;
        }
    });
});

    document.addEventListener("DOMContentLoaded", function () {
        const setorSelect = document.getElementById('setorlist');
        const sidebarSetor = document.getElementById('sidebar-setor');

        
        function carregarSetores() {
            fetch('/setores/dropdown')
                .then(response => response.json())
                .then(data => {
                    setorSelect.innerHTML = '<option value="" disabled selected>Selecione um setor</option>';

                
                    const novaOption = document.createElement('option');
                    novaOption.value = "novo";
                    novaOption.textContent = "+ Cadastrar novo setor";
                    novaOption.style.color = "green";
                    setorSelect.appendChild(novaOption);

                    // Adiciona os setores existentes
                    data.forEach(setor => {
                        const option = document.createElement('option');
                        option.value = setor.id;
                        option.textContent = setor.nome.toUpperCase();
                        setorSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Erro ao carregar os setores:', error));
        }

    
        carregarSetores();

    
        setorSelect.addEventListener('change', function () {
            if (this.value === 'novo') {
                document.getElementById('nome').value = ""; // Limpa o campo de nome do setor
                sidebarSetor.style.display = 'block'; // Abre o sidebar de setor
                this.value = ""; // Reseta o valor do select
            }
        });

        // Evento para o formulário de cadastro de setor
        const formSetor = document.getElementById('formSetor');
        formSetor.addEventListener('submit', function (event) {
            event.preventDefault(); // Evita o envio padrão

            const formData = new FormData(formSetor);
            fetch(formSetor.action, {
                method: 'POST',
                body: formData,
            })
                .then(response => {
                    if (response.ok) {
                        alert('Setor cadastrado com sucesso!');
                        sidebarSetor.style.display = 'none'; // Fecha o sidebar de setor
                        carregarSetores(); // Recarrega os setores no select
                    } else {
                        throw new Error('Erro ao salvar o setor.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao salvar o setor:', error);
                    alert('Erro ao salvar o setor.');
                });
        });

        // Função para fechar o sidebar de responsável
        function fecharResponsavelSidebar() {
            document.getElementById('sidebar-responsavel').style.display = 'none';
            document.getElementById('sidebar-correios').style.display = 'block';
        }

        // Torna a função disponível globalmente
        window.fecharResponsavelSidebar = fecharResponsavelSidebar;
    });

    function configurarFormularioFuncionario() {
    const formFuncionario = document.getElementById("formFuncionario");
    const sidebarFuncionario = document.getElementById("sidebar-funcionario");
    const sidebarCorreios = document.getElementById("sidebar-Correios");
    const funcionarioSelect = document.getElementById("funcionario");

    formFuncionario.addEventListener("submit", function (event) {
        event.preventDefault();

        // Captura os campos do formulário
        const primeiroNome = document.getElementById("primeiroNome").value.trim();
        const ultimoNome = document.getElementById("ultimoNome").value.trim();
        const setorId = document.getElementById("setorlist").value;

        if (!primeiroNome || !ultimoNome || !setorId) {
            alert("Preencha todos os campos.");
            return;
        }

        // Cria os dados no formato correto para o backend
        const formData = new URLSearchParams();
        formData.append("primeiroNome", primeiroNome);
        formData.append("ultimoNome", ultimoNome);
        formData.append("setorId", setorId);

        // Envia os dados para o backend
        fetch("/funcionarios/cadastrar", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData.toString(),
        })
        .then(response => {
            if (!response.ok) throw new Error("Erro ao salvar o funcionário.");
            return response.json();
        })
        .then(novoFuncionario => {
            console.log("Funcionário cadastrado:", novoFuncionario);

            // Adiciona o novo funcionário ao dropdown
            const novaOption = document.createElement("option");
            novaOption.value = novoFuncionario.id;
            novaOption.textContent = `${novoFuncionario.name} - ${novoFuncionario.setorNome}`;
            novaOption.selected = true;
            funcionarioSelect.appendChild(novaOption);

            // Atualiza o Select2
            $(funcionarioSelect).trigger("change");

            // Fecha o sidebar de funcionário e abre o de correios
            sidebarFuncionario.style.display = "none";
            sidebarCorreios.style.display = "block";

            // Limpa o formulário
            formFuncionario.reset();
        })
        .catch(error => {
            console.error("Erro ao salvar o funcionário:", error);
            alert("Erro ao salvar o funcionário. Verifique os dados e tente novamente.");
        });
    });
}



document.addEventListener('DOMContentLoaded', function () {
        
        const setorSelect = document.getElementById('setor');

        
        fetch('/setores/dropdown')
        .then(response => response.json())
        .then(data => {
            data.forEach(setor => {
                if (setor.codCorreios) { 
                    const option = document.createElement('option');
                    option.value = setor.id;
                    option.textContent = `${setor.nome} - ${setor.codCorreios}`; // Formata o texto como "Nome - CodCorreios"
                    setorSelect.appendChild(option);
                }
            });
        })
        .catch(error => console.error('Erro ao carregar os setores:', error));

        });

    function filter() {
        const input = document.getElementById('search-input');
        const filter = input.value.toLowerCase(); 
        const table = document.querySelector('table');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) { 
            const cells = rows[i].getElementsByTagName('td');
            let match = false;

            for (let j = 0; j < cells.length; j++) {
                if (cells[j].innerText.toLowerCase().indexOf(filter) > -1) {
                    match = true;
                    break;
                }
            }

            rows[i].style.display = match ? '' : 'none'; 
        }
    }

    function exportVisibleToCSV() {
    const rows = document.querySelectorAll("table tbody tr");
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
    csvContent += "ID;Funcionário;Setor;Horário;Código Postal;Destinatário;Serviço\n";

    rows.forEach(row => {
        if (row.style.display !== "none") { // Considera apenas linhas visíveis
            const cells = row.querySelectorAll("td");
            const id = cells[0].innerText;
            const funcionario = cells[1].innerText;
            const setor = cells[2].innerText;
            const horario = cells[3].innerText;
            const codigoPostal = cells[4].innerText;
            const destinatario = cells[5].innerText;
            const servico = cells[6].innerText;
            const entregador = cells[7].innerText;
            csvContent += `${id};${funcionario};${setor};${horario};${codigoPostal};${destinatario};${servico};${entregador}\n`;
        }
    });

    if (csvContent.trim() === "data:text/csv;charset=utf-8,\uFEFF\nID;Funcionário;Setor;Horário;Código Postal;Destinatário;Serviço;entregador\n") {
        alert("Nenhum dado disponível para download.");
        return;
    }

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "dados_correios.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Preencher select de funcionários no sidebar-Correios
async function populateFuncionariosSelect() {
    const funcionarioSelect = $('#funcionario'); // Select no sidebar-Correios
    const sidebarFuncionario = document.getElementById('sidebar-funcionario'); // Sidebar de cadastro de funcionário
    const spinner = $('#loading'); // Elemento de loading (se existir)

    try {
        // Limpa o select e adiciona as opções padrão
        funcionarioSelect.empty().append(
            $('<option>', { value: '', disabled: true, selected: true, text: 'Pesquise ou selecione um funcionário' })
        ).append(
            $('<option>', { value: 'novo', text: '+ Cadastrar novo funcionário' }).addClass('highlight-option')
        );

        // Busca os dados da API e do banco local simultaneamente
        const [apiUsuarios, dbFuncionarios] = await Promise.all([
            fetch("/users/api/users").then(res => res.json()), // Dados da API externa
            fetch("/funcionarios/listar").then(res => res.json()) // Dados do banco local
        ]);

        // Adiciona os usuários da API ao select
        apiUsuarios.forEach(user => {
            funcionarioSelect.append(
                $('<option>', {
                    value: user.officeLocation ? `${user.displayName} - ${user.officeLocation}` : user.displayName,
                    text: user.displayName
                })
            );
        });

        // Adiciona os funcionários do banco local ao select
        dbFuncionarios.forEach(funcionario => {
            funcionarioSelect.append(
                $('<option>', {
                    value: funcionario.id,
                    text: `${funcionario.name} - ${funcionario.setorNome?.toUpperCase() || 'SEM SETOR'}`
                })
            );
        });


        // Inicializa o Select2 com formatação especial
        funcionarioSelect.select2({
            placeholder: 'Pesquise ou selecione um funcionário',
            allowClear: true,
            templateResult: function (data) {
                // Formata a opção "+ Cadastrar novo funcionário"
                if (data.id === 'novo') {
                    return $('<span>').text(data.text).css({ color: 'green', fontWeight: 'bold' });
                }
                return data.text;
            },
            templateSelection: function (data) {
                return data.text;
            }
        });

        // Evento para abrir o sidebar de cadastro ao selecionar "+ Cadastrar novo funcionário"
        funcionarioSelect.on('change', function () {
            if (this.value === 'novo') {
                abrirSidebarCadastroFuncionario();
                funcionarioSelect.val(null).trigger('change'); // Reseta o select
            }
        });

        // Esconde o spinner e mostra o select (se existir o spinner)
        if (spinner.length) spinner.hide();
        funcionarioSelect.show();

    } catch (error) {
        console.error('Erro ao carregar os funcionários:', error);
    }
}

// Função para abrir o sidebar de cadastro de funcionário
function abrirSidebarCadastroFuncionario() {
    document.getElementById('sidebar-funcionario').style.display = 'block';
}

// Inicializa o script ao carregar a página
document.addEventListener('DOMContentLoaded', populateFuncionariosSelect);




document.addEventListener('DOMContentLoaded', function () {
        // Seleciona todas as linhas da tabela
        const tableRows = document.querySelectorAll("table tbody tr");

        // Seleciona o modal e seus elementos
        const modal = document.getElementById("infoModal");
        const closeModal = document.querySelector(".close");
        const modalId = document.getElementById("modal-id");
        const modalFuncionario = document.getElementById("modal-funcionario");
        const modalSetor = document.getElementById("modal-setor");
        const modalHorario = document.getElementById("modal-horario");
        const modalCodigoPostal = document.getElementById("modal-codigoPostal");
        const modalDestinatario = document.getElementById("modal-destinatario");
        const modalServico = document.getElementById("modal-servico");
        const modalEntregador = document.getElementById("modal-entregador");

        // Adiciona evento de clique em cada linha
        tableRows.forEach(row => {
            row.addEventListener('click', function () {
                // Obtém os dados da linha clicada
                const cells = this.querySelectorAll("td");

                // Preenche os dados no modal
                modalId.textContent = cells[0].textContent;
                modalFuncionario.textContent = cells[1].textContent;
                modalSetor.textContent = cells[2].textContent;
                modalHorario.textContent = cells[3].textContent;
                modalCodigoPostal.textContent = cells[4].textContent;
                modalDestinatario.textContent = cells[5].textContent;
                modalServico.textContent = cells[6].textContent;
                modalEntregador.textContent = cells[7].textContent;

                // Exibe o modal
                modal.style.display = "block";
            });
        });

        // Fecha o modal
        closeModal.addEventListener('click', function () {
            modal.style.display = "none";
        });

        // Fecha o modal ao clicar fora do conteúdo
        window.addEventListener('click', function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        });

        // Botões de editar e excluir
        document.getElementById("edit-button").addEventListener("click", function () {
            alert("Função de edição ainda não implementada.");
        });

        document.getElementById("delete-button").addEventListener("click", function () {
            const id = document.getElementById("modal-id").textContent;
            deleteRecord(id);
        });


    });


    function deleteRecord(id) {
    // Exibe o modal de confirmação
    customConfirm("Tem certeza de que deseja excluir este registro?")
        .then((confirmado) => {
            if (confirmado) {
                // Se confirmado, realiza a requisição de exclusão
                fetch(`/correios/${id}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    // Verifica o status da resposta
                    if (response.status === 204) {
                        // Registro excluído com sucesso
                        location.reload();

                        showAlert("Registro excluído com sucesso.", () => {
                            // Remove a linha correspondente da tabela
                            document.querySelector(`tr[data-id="${id}"]`).remove();
                            // Fecha o modal de detalhes (se estiver aberto)
                            document.getElementById("infoModal").style.display = "none";
                        });
                    } else if (response.status === 404) {
                        // Registro não encontrado
                        showAlert("Registro não encontrado.");
                    } else {
                        // Outro erro na exclusão
                        showAlert("Ocorreu um erro ao excluir o registro.");
                    }
                })
                .catch(error => {
                    // Trata erros da requisição
                    console.error("Erro ao excluir o registro:", error);
                });
            } else {
                // Usuário cancelou a ação
                console.log("Ação de exclusão cancelada.");
            }
        });
}

function toggleDropdown(menuId) {
    const menu = document.getElementById(menuId);
    if (menu.style.display === "none" || !menu.style.display) {
        
        document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
       
        menu.style.display = "block";
    } else {
       
        menu.style.display = "none";
    }
}

$(document).ready(function() {
            $("#sidebar-container").load("/fragment/sidebar.html");
        });
</script>



</script>



	</body>
    
</html>  