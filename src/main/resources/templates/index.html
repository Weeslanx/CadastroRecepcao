<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Entradas</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/responsivo.css">

 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
	
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
   

	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
	 <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
	 




</head>
<body>


    <div id="sidebar-container"></div> 
    
       <div class = "menu"> 
       
        <h1> Registro de Entradas</h1>
        	
        	
								   <button class="add-visitor" id="add-visitor-btn">
								      <i class="fa fa-id-badge"  ></i>Cadastrar Visitante
								   
								   			
								   </button>
						           <button class="add-visit" id="add-visit-btn">
									    <i class="fas fa-plus"></i> Adicionar Visita
									</button>
                                    <div class="logo-container">
                                        <img src="/images/logo3.png" alt="Logo" class="logo-img">
                                    </div>
       </div>
       
       
    
    
       <div class="main-content">
        <div class="card-container" id="visitas-container">
            <th:block th:each="visita : ${visitas}" th:if="${visita.horarioSaida} == null">
                <div class="card">
                    <div class="card-content">
                        <div class="cardicon">
                            <i class="fa fa-paper-plane"></i>
                        </div>
                        <h3 th:text="${visita.visitante.nome}">Nome Visitante</h3>
                        <p><strong>Tipo:</strong> <span th:text="${visita.categoria.nome}">Nome Categoria</span></p>
                        <p><strong>Responsável:</strong> <span th:text="${visita.responsavel}">Nome Categoria</span></p>
                        <p><strong>Horário de Entrada:</strong> <span th:text="${visita.horarioEntradaFormatado}">Horário Entrada</span></p>
                        <p><strong>Cartão:</strong> <span th:text="${visita.cracha}">Cartão</span></p>
                    </div>
    
                    <button class="btn-card saida" th:onclick="'abrirSidebar(' + ${visita.id} + ')'">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
    
                    <button class="btn-card delet" th:onclick="'deletarVisita(' + ${visita.id} + ')'">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </th:block>
        </div>
    </div>
    
            
            

			<div class="sidebar-right" id="sidebar-visitor" style="display: none;z-index: 1001;">
			                <button class="close-btn" id="close-btn">&times;</button> 
							<br><br>
                            <h2>Cadastrar Visitante</h2>
                            <form id="formVisitante">
                                <label for="nomeVisitante">Nome do Visitante</label>
                                <input type="text" id="nomeVisitante" name="nome" required />
                        
                                <label for="empresaVisitante">Empresa</label>
                                <input type="text" id="empresaVisitante" name="empresa" />
                        
                                <label for="documentoVisitante">Documento</label>
                                <input type="text" id="documentoVisitante" name="documento" />
                        
                                <button class="btn" type="submit">Salvar</button>
                            </form>
                        </div>
						
						<div class="sidebar-right" id="sidebar-category" style="display: none;z-index: 1001;">
						    <button class="close-btn" onclick="toggleDropdown('sidebar-category')">&times;</button> 
						    <br><br>
							<form id="formCategoria">
                                <label for="nomeCategoria">Nome da Categoria</label>
                                <input type="text" id="nomeCategoria" name="nome" required />
                                <button class="btn" type="submit">Salvar</button>
                            </form>
						</div>
						
						<div class="sidebar-right" id="sidebar-responsavel" style="display: none;z-index: 1001;">
                            <button class="close-btn" onclick="fecharResponsavelSidebar()">&times;</button>
                            <h2>Cadastrar Responsável</h2>
                            <form id="formFuncionario">
                                <label for="primeiroNome">Primeiro Nome</label>
                                <input type="text" id="primeiroNome" name="primeiroNome" required />
                        
                                <label for="ultimoNome">Último Nome</label>
                                <input type="text" id="ultimoNome" name="ultimoNome" required />
                        
                                <label for="setor">Setor</label>
                                <select id="setorlist" name="setorId" required>
                                    <option value="" disabled selected>Selecione um setor</option>
                                </select>
                        
                                <button class="btn" type="submit">Salvar</button>
                            </form>
                        </div>
                        
						
						
						
						<div class="sidebar-right" id="sidebar-add-saida" style="display: none;">
						    <button class="close-btn" id="close-saida-btn">&times;</button>
						    <br><br>
						    <input type="datetime-local" id="horarioSaida" />
						    <button class ="btn" onclick="atualizarHorarioSaida()">Atualizar Horário de Saída</button>
						</div>
						
						

						<div class="sidebar-right" id="sidebar-visitas" style="display: none; ">
                            <button class="close-btn" id="close-visitas-btn">&times;</button>
                            <br>
                            <h2>Nova Visita</h2>
                            <form id="visitaForm" action="/visitas/cadastrar" method="post" onsubmit="verificarECadastrarVisita(event)">
                                <input type="hidden" name="_csrf" value="${_csrf.token}">
                            
                                <label for="visitante">Visitante</label>
                                <select id="visitante" name="visitante.id" class="select2" required>
                                    <option value="">Selecione um visitante</option>
                                </select>
                                <br><br>
                            
                                <label for="categoria">Categoria</label>
                                <select id="categoria" name="categoria.id" class="select2" required>
                                    <option value="">Selecione uma categoria</option>
                                </select>
                                <br><br>
                            
                                <label for="responsavel">Responsável</label>
                                <select id="responsavel" name="responsavel" class="select2" required>
                                    <option value="">Selecione um responsável</option>
                                </select>
                                <br><br>
                            
                                <label for="horarioEntrada">Horário de Entrada</label>
                                <input type="datetime-local" id="horarioEntrada" name="horarioEntrada" required>
                                <br><br>
                            
                                <label for="cracha">Crachá</label>
                                <input type="number" id="cracha" name="cracha" min="1" max="30" required>
                                <br><br>
                            
                                <div id="error-message" style="color: red; display: none;"></div>
                                <div id="success-message" style="color: green; display: none;"></div>
                                <br>
                            
                                <button type="submit" class="btn">Salvar Visita</button>
                            </form>
                        </div>
                        
						
								  
						       </div>
						  
			    

<script>

document.addEventListener("DOMContentLoaded", function () {
   
    configurarFormularioVisitante();
    populateResponsaveisSelect()
    configurarFormularioCategoria();
    configurarFormularioResponsavel();
});

function configurarFormularioResponsavel() {
    const formFuncionario = document.getElementById("formFuncionario");
    const sidebarResponsavel = document.getElementById("sidebar-responsavel");
    const sidebarVisitas = document.getElementById("sidebar-visitas");
    const responsavelSelect = document.getElementById("responsavel");

    formFuncionario.addEventListener("submit", async function (event) {
        event.preventDefault(); // Bloqueia o envio padrão do formulário
        const formData = new FormData(formFuncionario);

        try {
            const response = await fetch("/funcionarios/cadastrar", {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                throw new Error("Erro ao salvar o responsável.");
            }

            const novoResponsavel = await response.json();

            // Adiciona o novo responsável ao dropdown
            const novaOption = new Option(
                `${novoResponsavel.name} - ${novoResponsavel.setorNome || "SEM DEPARTAMENTO"}`,
                novoResponsavel.id,
                false,
                true
            );
            responsavelSelect.add(novaOption);

            // Atualiza o Select2, se necessário
            $(responsavelSelect).trigger("change");

            // Fecha o sidebar de responsável e abre o de visitas
            sidebarResponsavel.style.display = "none";
            sidebarVisitas.style.display = "block";

            // Limpa o formulário
            formFuncionario.reset();
        } catch (error) {
            console.error("Erro ao salvar o responsável:", error);
            alert("Erro ao salvar o responsável. Tente novamente.");
        }
    });
}



// Função para configurar o formulário de visitante
function configurarFormularioVisitante() {
    const formVisitante = document.getElementById("formVisitante");
    const sidebarVisitor = document.getElementById("sidebar-visitor");
    const sidebarVisitas = document.getElementById("sidebar-visitas");
    const visitanteSelect = document.getElementById("visitante");

    formVisitante.addEventListener("submit", function (event) {
        event.preventDefault(); // Impede o envio padrão

        const formData = new FormData(formVisitante);

        fetch("/visitantes/cadastrar", {
            method: "POST",
            body: formData,
        })
        .then(response => {
            if (!response.ok) throw new Error("Erro ao salvar o visitante.");
            return response.json();
        })
        .then(novoVisitante => {
            // Fecha o sidebar de visitante
            sidebarVisitor.style.display = "none";

            // Adiciona o visitante ao dropdown
            const novaOption = document.createElement("option");
            novaOption.value = novoVisitante.id;
            novaOption.textContent = novoVisitante.nome;
            novaOption.selected = true;
            visitanteSelect.appendChild(novaOption);

            // Atualiza o Select2, se necessário
            $(visitanteSelect).trigger("change");

            // Abre o sidebar-visitas
            sidebarVisitas.style.display = "block";

            // Limpa o formulário
            formVisitante.reset();
        })
        .catch(error => {
            console.error("Erro ao salvar o visitante:", error);
            alert("Erro ao salvar o visitante. Tente novamente.");
        });
    });
}

// Função para configurar o formulário de categoria
function configurarFormularioCategoria() {
    const formCategoria = document.getElementById("formCategoria");
    const sidebarCategoria = document.getElementById("sidebar-category");
    const sidebarVisitas = document.getElementById("sidebar-visitas");
    const categoriaSelect = document.getElementById("categoria");

    formCategoria.addEventListener("submit", function (event) {
        event.preventDefault(); // Bloqueia o envio padrão

        const formData = new FormData(formCategoria);

        fetch("/categorias/novocadastro", {
            method: "POST",
            body: formData,
        })
        .then(response => {
            if (!response.ok) throw new Error("Erro ao salvar a categoria.");
            return response.json();
        })
        .then(novaCategoria => {
            // Fecha o sidebar de categoria
            sidebarCategoria.style.display = "none";

            // Adiciona a nova categoria ao dropdown
            const novaOption = document.createElement("option");
            novaOption.value = novaCategoria.id;
            novaOption.textContent = novaCategoria.nome;
            novaOption.selected = true;
            categoriaSelect.appendChild(novaOption);

            // Atualiza o Select2, se necessário
            $(categoriaSelect).trigger("change");

            // Abre o sidebar-visitas
            sidebarVisitas.style.display = "block";

            // Limpa o formulário
            formCategoria.reset();
        })
        .catch(error => {
            console.error("Erro ao salvar a categoria:", error);
            alert("Erro ao salvar a categoria. Tente novamente.");
        });ve
    });
}







document.addEventListener("DOMContentLoaded", function () {
    const setorSelect = document.getElementById('setorlist');
    const sidebarSetor = document.getElementById('sidebar-setor');

    
    function carregarSetores() {
        fetch('/setores/dropdown')
            .then(response => response.json())
            .then(data => {
                setorSelect.innerHTML = '<option value="" disabled selected>Selecione um setor</option>';

              
                const novaOption = document.createElement('option');
                novaOption.value = "novo";
                novaOption.textContent = "+ Cadastrar novo setor";
                novaOption.style.color = "green";
                setorSelect.appendChild(novaOption);

                // Adiciona os setores existentes
                data.forEach(setor => {
                    const option = document.createElement('option');
                    option.value = setor.id;
                    option.textContent = setor.nome.toUpperCase();
                    setorSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Erro ao carregar os setores:', error));
    }

   
    carregarSetores();

 
    setorSelect.addEventListener('change', function () {
        if (this.value === 'novo') {
            document.getElementById('nome').value = ""; // Limpa o campo de nome do setor
            sidebarSetor.style.display = 'block'; // Abre o sidebar de setor
            this.value = ""; // Reseta o valor do select
        }
    });

    // Evento para o formulário de cadastro de setor
    const formSetor = document.getElementById('formSetor');
    formSetor.addEventListener('submit', function (event) {
        event.preventDefault(); // Evita o envio padrão

        const formData = new FormData(formSetor);
        fetch(formSetor.action, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (response.ok) {
                    alert('Setor cadastrado com sucesso!');
                    sidebarSetor.style.display = 'none'; // Fecha o sidebar de setor
                    carregarSetores(); // Recarrega os setores no select
                } else {
                    throw new Error('Erro ao salvar o setor.');
                }
            })
            .catch(error => {
                console.error('Erro ao salvar o setor:', error);
                alert('Erro ao salvar o setor.');
            });
    });

    // Função para fechar o sidebar de responsável
    function fecharResponsavelSidebar() {
        document.getElementById('sidebar-responsavel').style.display = 'none';
        document.getElementById('sidebar-visitas').style.display = 'block';
    }

    // Torna a função disponível globalmente
    window.fecharResponsavelSidebar = fecharResponsavelSidebar;
});

    // Inicialização do Sidebar
    $(document).ready(function () {
        $("#sidebar-container").load("/fragment/sidebar.html");
    });

    
    document.addEventListener("DOMContentLoaded", function () {
    const forms = document.querySelectorAll("form");
    forms.forEach(form => {
        form.addEventListener("submit", function (e) {
            // Verifica se o formulário está sendo submetido sem intervenção
            const validated = form.dataset.validated === "true";

            if (!validated) {
                e.preventDefault(); // Bloqueia o envio até que seja validado
            } else {
                const submitButton = form.querySelector("button[type='submit']");
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = "Salvando...";
                }
            }
        });

    });
});

    
    // Função para deletar uma visita
    async function deletarVisita(visitaId) {
        const confirmar = confirm("Tem certeza que deseja excluir este cadastro?");
        if (!confirmar) return;

        try {
            const response = await fetch(`/visitas/deletar/${visitaId}`, { method: 'DELETE' });
            if (response.ok) {
                alert("Cadastro excluído com sucesso!");
                location.reload();
            } else {
                alert("Erro ao excluir o cadastro.");
            }
        } catch (error) {
            console.error("Erro ao excluir a visita:", error);
            alert("Erro ao excluir o cadastro.");
        }
    }

    // Preencher select de responsáveis
    async function populateResponsaveisSelect() {
    const responsavelSelect = $('#responsavel');
    const sidebarResponsavel = document.getElementById('sidebar-responsavel');

    try {
        // Limpa e inicializa o select com opções padrão
        responsavelSelect.empty().append(
            new Option('Pesquise ou selecione um responsável', '', true, true)
        ).append(
            new Option('+ Adicionar novo responsável', 'novo')
        );

        const [apiUsers, dbResponsaveis] = await Promise.all([
            fetch("/users/api/users").then(res => res.json()),
            fetch("/funcionarios/listar").then(res => res.json())
        ]);

        // Adiciona os responsáveis vindos da API
        apiUsers.forEach(user => {
            responsavelSelect.append(
                new Option(user.displayName, user.displayName)
            );
        });

        // Adiciona os responsáveis vindos do banco local
        dbResponsaveis.forEach(responsavel => {
            responsavelSelect.append(
                new Option(
                    `${responsavel.name} - ${responsavel.setorNome?.toUpperCase() || 'SEM SETOR'}`,
                    responsavel.id
                )
            );
        });

        // Inicializa o Select2
        responsavelSelect.select2({
            placeholder: 'Pesquise ou selecione',
            allowClear: true,
            templateResult: formatarOpcao,
            templateSelection: formatarOpcao,
        });

        // Lógica para abrir o modal de novo responsável
        responsavelSelect.on("change", function () {
            if (this.value === "novo") {
                sidebarResponsavel.style.display = "block";
                responsavelSelect.val(null).trigger("change");
            }
        });
    } catch (error) {
        console.error("Erro ao carregar os responsáveis:", error);
    }
}

// Formata as opções no Select2
function formatarOpcao(data) {
    if (data.id === "novo") {
        return $('<span>').text(data.text).css({ color: "green", fontWeight: "bold" });
    }
    return data.text;
}

    // Gerenciamento de sidebars
    let currentVisitaId = null;

    function abrirSidebar(visitaId) {
        currentVisitaId = visitaId;
        document.getElementById('sidebar-add-saida').style.display = 'block';
    }

    function fecharSidebar() {
        document.getElementById('sidebar-add-saida').style.display = 'none';
        currentVisitaId = null;
    }

    document.getElementById('close-saida-btn').addEventListener('click', fecharSidebar);

    function atualizarHorarioSaida() {
        const horarioSaida = document.getElementById('horarioSaida').value;

        if (horarioSaida && currentVisitaId) {
            fetch('/visitas/atualizar-saida', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${currentVisitaId}&horarioSaida=${encodeURIComponent(horarioSaida)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        fecharSidebar();
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao atualizar o horário de saída.');
                });
        } else {
            alert('Por favor, informe o horário de saída.');
        }
    }

    // Configuração do Select2
    $(document).ready(function () {
        $('.select2').select2({ placeholder: "Selecione uma opção", allowClear: true });
    });

    // Abertura e fechamento de sidebars
    document.getElementById('add-visitor-btn').addEventListener('click', function () {
        document.getElementById('sidebar-visitor').style.display = 'block';
    });

    document.getElementById('close-btn').addEventListener('click', function () {
        document.getElementById('sidebar-visitor').style.display = 'none';
    });

    document.getElementById('add-visit-btn').addEventListener('click', function () {
        const sidebarRight = document.getElementById('sidebar-visitas');
        sidebarRight.style.display = 'block';

        fetch('/visitas/dados')
            .then(response => response.json())
            .then(data => {
                const visitanteSelect = $('#visitante');
                const categoriaSelect = $('#categoria');
                const sidebarVisitante = document.getElementById('sidebar-visitor');
                const sidebarCategoria = document.getElementById('sidebar-category');

                visitanteSelect.empty().append(
                    $('<option>', { value: '', disabled: true, selected: true, text: 'Selecione um visitante' })
                ).append(
                    $('<option>', { value: 'novo', text: '+ Cadastrar novo visitante' }).addClass('highlight-option')
                );

                data.visitantes.forEach(visitante => {
                    visitanteSelect.append(
                        $('<option>', { value: visitante.id, text: visitante.nome })
                    );
                });

                visitanteSelect.select2({
                    placeholder: 'Selecione um visitante',
                    allowClear: true,
                    templateResult: function (data) {
                        if (data.id === 'novo') {
                            return $('<span>').text(data.text).css({ color: 'green', fontWeight: 'bold' });
                        }
                        return data.text;
                    }
                });

                visitanteSelect.on('change', function () {
                    if (this.value === 'novo') {
                        sidebarVisitante.style.display = 'block';
                        visitanteSelect.val(null).trigger('change');
                    }
                });

                categoriaSelect.empty().append(
                    $('<option>', { value: '', disabled: true, selected: true, text: 'Selecione uma categoria' })
                ).append(
                    $('<option>', { value: 'novo', text: '+ Cadastrar nova categoria' }).addClass('highlight-option')
                );

                data.categorias.forEach(categoria => {
                    categoriaSelect.append(
                        $('<option>', { value: categoria.id, text: categoria.nome })
                    );
                });

                categoriaSelect.select2({
                    placeholder: 'Selecione uma categoria',
                    allowClear: true,
                    templateResult: function (data) {
                        if (data.id === 'novo') {
                            return $('<span>').text(data.text).css({ color: 'green', fontWeight: 'bold' });
                        }
                        return data.text;
                    }
                });

                categoriaSelect.on('change', function () {
                    if (this.value === 'novo') {
                        sidebarCategoria.style.display = 'block';
                        categoriaSelect.val(null).trigger('change');
                    }
                });
            })
            .catch(error => console.error('Erro ao carregar dados:', error));
    });

    // Fechar sidebars adicionais
    document.getElementById('close-visitas-btn').addEventListener('click', function () {
        document.getElementById('sidebar-visitas').style.display = 'none';
    });

    document.getElementById('add-category').addEventListener('click', function () {
        document.getElementById('sidebar-category').style.display = 'block';
    });

    document.getElementById('close-category-btn').addEventListener('click', function () {
        document.getElementById('sidebar-category').style.display = 'none';
    });

    // Função para alternar dropdowns
    function toggleDropdown(menuId) {
        const menu = document.getElementById(menuId);
        if (menu.style.display === "none" || !menu.style.display) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
            menu.style.display = "block";
        } else {
            menu.style.display = "none";
        }
    }

    async function verificarECadastrarVisita(event) {
    event.preventDefault(); // Impede o envio direto do formulário.

    const form = document.getElementById("visitaForm");
    const cracha = document.getElementById("cracha").value.trim();
    const errorMessage = document.getElementById("error-message");
    const successMessage = document.getElementById("success-message");

    // Oculta mensagens anteriores.
    errorMessage.style.display = "none";
    successMessage.style.display = "none";

    try {
        // Faz a verificação do crachá no backend.
        const response = await fetch(`/visitas/verificar-cracha?cracha=${encodeURIComponent(cracha)}`);
        const data = await response.json();

        if (data.emUso) {
            // Exibe mensagem de erro se o crachá estiver em uso.
            errorMessage.textContent = `O crachá ${cracha} já está em uso. Por favor, escolha outro.`;
            errorMessage.style.display = "block";
        } else {
            // Crachá válido. Exibe mensagem de sucesso e envia o formulário.
            successMessage.textContent = "Crachá válido! Salvando visita...";
            successMessage.style.display = "block";

            // Envia os dados do formulário.
            const formData = new FormData(form);
            const postResponse = await fetch(form.action, {
                method: "POST",
                body: formData,
            });

            if (postResponse.ok) {
                alert("Visita cadastrada com sucesso!");
                location.reload(); // Recarrega a página após salvar.
            } else {
                throw new Error("Erro ao salvar a visita.");
            }
        }
    } catch (error) {
        console.error("Erro ao verificar ou salvar a visita:", error);
        errorMessage.textContent = "Erro ao processar a solicitação. Tente novamente.";
        errorMessage.style.display = "block";
    }
}

    
    // Alternar a exibição do sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("open");

        const title = document.querySelector(".logo-container");
        title.classList.toggle("open");
    }


    document.getElementById('formFuncionario').addEventListener('submit', async function (e) {
    e.preventDefault(); // Previne o comportamento padrão do formulário

    const form = e.target;
    const formData = new FormData(form);
    
    try {
        
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            alert('Responsável cadastrado com sucesso!');

            
            document.getElementById('sidebar-responsavel').style.display = 'none';


            const sidebarVisitas = document.getElementById('sidebar-visitas');
            sidebarVisitas.style.display = 'block';


            await populateResponsaveisSelect();

        } else {
            alert('Erro ao cadastrar responsável. Tente novamente.');
        }
    } catch (error) {
        console.error('Erro ao cadastrar responsável:', error);
        alert('Ocorreu um erro. Tente novamente.');
    }
});

function fecharResponsavelSidebar() {
    document.getElementById('sidebar-responsavel').style.display = 'none';
    document.getElementById('sidebar-visitas').style.display = 'block';
}





</script>
                            


	</body>

</html>  