<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Entradas</title>
    <link rel="stylesheet" href="/styles.css">

 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
	
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
	 <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
	




</head>
<body>



    <div id="sidebar-container"></div> 


    <div id="loading">
        <div class="spinner"></div>
        <h2>Carregando...</h2> 
    </div>

    <div id="customConfirm" class="custom-confirm">
        <div class="custom-confirm-content">
            <p id="customConfirmMessage">Você tem certeza?</p>
            <div class="custom-confirm-buttons">
                <button id="confirmYes" class="btn-confirm">Sim</button>
                <button id="confirmNo" class="btn-cancel">Não</button>
            </div>
        </div>
    </div>


    <div id="customAlert" class="custom-alert">
        <div class="custom-alert-content">
            <p id="customAlertMessage">Mensagem</p>
            <button id="alertOk" class="btn-confirm">OK</button>
        </div>
    </div>



    
       <div class = "menu"> 
       
        <h1> Registro de Chaves</h1>
        	
        	
								   <button class="add-visit"  onclick="toggleDropdown('sidebar-Regischave')">
                                    <i class="fas fa-plus"></i>Novo Solicitante  	
								   </button>

						           
                                             
                                 
                                    
                                    <div class="logo-container">
                                        <img src="/images/logo3.png" alt="Logo" class="logo-img">
                                    </div>


                                   
       </div>
     
       
    
      
       <div class="main-content">

        <div class="sidebar-right" id="sidebar-funcionario" style="display: none;">
            <button class="close-btn" data-sidebar="sidebar-funcionario" data-display="none">&times;</button>
            <h2>Cadastrar Funcionário</h2>
            <form id="formFuncionario" action="/funcionarios/cadastrar" method="POST">
                <label for="primeiroNome">Primeiro Nome</label>
                <input type="text" id="primeiroNome" name="primeiroNome" required />
        
                <label for="ultimoNome">Último Nome</label>
                <input type="text" id="ultimoNome" name="ultimoNome" required />
        
                <label for="setor">Setor</label>
                <select id="setorlist" name="setorId" required>
                    <option value="" disabled selected>Selecione um setor</option>
                </select>
        
                <button class="btn" type="submit">Salvar</button>
            </form>
        </div>



        <div class="sidebar-right" id="sidebar-setor" style="display: none;">
            <button class="close-btn" data-sidebar="sidebar-setor" data-display="none">&times;</button>
            <h2>Cadastrar Setor</h2>
            <form id="formSetor" action="/setores/cadastrar" method="POST">
                <label for="nome">Nome do Setor</label>
                <input type="text" id="nome" name="nome" required />
                <button class="btn" type="submit">Salvar</button>
            </form>
        </div>
        
        

        <div class="card-container" id="chave-container">
            <th:block th:each="regisChave : ${rchaves}" th:if="${regisChave.devol} == null">
                <div class="card">
                    <div class="card-content">
                        <div class="cardicon">
                            <i class="fa fa-key"></i>
                        </div>
                        <h3 th:text="${regisChave.requisi}">Solicitante</h3>
                        <p>
                            <strong>Chave:</strong>
                            <span th:text="${regisChave.chave?.local ?: 'Local não informado'}">Chave</span>
                        </p>
                        <p>
                            <strong>Horário de Retirada:</strong>
                            <span th:text="${#temporals.format(regisChave.saida, 'dd/MM/yyyy HH:mm')}">Retirada</span>
                        </p>
                    </div>
                    <button class="btn-card saida" th:onclick="'abrirSidebar(' + ${regisChave.id} + ')'">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <button class="btn-card delet" th:onclick="'deletarRegistro(' + ${regisChave.id} + ')'">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </th:block>
        </div>
        
        <div class="sidebar-right" id="sidebar-add-saida" style="display: none;">
            <button class="close-btn" id="close-saida-btn">&times;</button>
            <br><br>
            <input type="datetime-local" id="horarioSaida" />
            <button class ="btn" onclick="atualizarHorarioSaida()">Atualizar Horário de Saída</button>
        </div>   

        <div class="sidebar-right" id="sidebar-Regischave" style="display: none;">
            <button class="close-btn" onclick="toggleDropdown('sidebar-Regischave')">&times;</button>
            <h2>Cadastrar Solicitante</h2>
                <form action="/chave/registrar" method="POST">

                <label for="solicitante">Solicitante</label>
                <select id="solicitante" name="solicitante" class="select2" required>
                    <option value="" disabled selected>Selecione um solicitante</option>
                </select>

                <br><br>



                    <label for="chave">Chave</label>
                    <select id="chavelist" name="chave" class="select2"  required>
                        <option value="" disabled selected></option>
                    </select>
                    <br><br>

                    <label for="horarioEntrada">Hora de Retirada</label>
                    <input type="datetime-local" id="saida" name="saida" required>

                    <button class="btn"  type="submit">Salvar</button>
                </form>
        </div>  


                <div class="sidebar-right" id="sidebar-chave" style="display: none;">
                    <button class="close-btn" onclick="toggleDropdown('sidebar-chave')">&times;</button>
                    <h2>Cadastrar chave</h2>
                        <form action="/chave/cadastrar" method="POST">

                            <label for="chave">N° Chave</label>
                            <input type="text" id="cod" name="cod" required>

                            <br><br>
                            <label for="local">Local</label>
                            <input type="text" id="local" name="local" required>




                            <button class="btn"  type="submit">Salvar</button>
                        </form>
                </div>  


                
                
<script>

// DOM Loaded Events
document.addEventListener("DOMContentLoaded", populateSolicitantesSelect);
document.addEventListener("DOMContentLoaded", function() {
    const setorSelect = document.getElementById('setorlist');
    const sidebarSetor = document.getElementById('sidebar-setor');

    fetch('/setores/dropdown')
        .then(response => response.json())
        .then(data => {
            const novaOption = document.createElement('option');
            novaOption.value = "novo";
            novaOption.textContent = "+ Cadastrar novo setor";
            novaOption.style.color = "green";
            setorSelect.appendChild(novaOption);

            data.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor.id;
                option.textContent = setor.nome.toUpperCase();
                setorSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Erro ao carregar os setores:', error));

    setorSelect.addEventListener('change', function () {
        if (this.value === 'novo') {
            document.getElementById('nome').value = "";
            sidebarSetor.style.display = 'block';
            this.value = "";
        }
    });

    const formSetor = document.getElementById('formSetor');
    formSetor.addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(formSetor);
        fetch(formSetor.action, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (response.ok) {
                    sidebarSetor.style.display = 'none';
                    setorSelect.innerHTML = '<option value="" disabled selected>Selecione um setor</option>';
                    fetch('/setores/dropdown')
                        .then(response => response.json())
                        .then(data => {
                            const novaOption = document.createElement('option');
                            novaOption.value = "novo";
                            novaOption.textContent = "+ Cadastrar novo setor";
                            novaOption.style.color = "green";
                            setorSelect.appendChild(novaOption);

                            data.forEach(setor => {
                                const option = document.createElement('option');
                                option.value = setor.id;
                                option.textContent = setor.nome.toUpperCase();
                                setorSelect.appendChild(option);
                            });
                        });
                } else {
                    throw new Error('Erro ao salvar o setor.');
                }
            })
            .catch(error => {
                console.error('Erro ao salvar o setor:', error);
                alert('Erro ao salvar o setor.');
            });
    });
});

$(document).ready(function() {
    $("#sidebar-container").load("/fragment/sidebar.html");
});


document.addEventListener('DOMContentLoaded', function () {
    const chaveSelect = $('#chavelist');
    const sidebarChave = document.getElementById('sidebar-chave');
    const sidebarRegischave = document.getElementById('sidebar-Regischave');

    function reloadChaveList() {
        fetch('/chave/list')
            .then(response => response.json())
            .then(data => {
                chaveSelect.empty();

                // Placeholder
                chaveSelect.append(
                    $('<option>', {
                        value: '',
                        disabled: true,
                        selected: true,
                        text: 'Pesquise ou selecione',
                    })
                );

                // "+ Cadastrar nova chave" com destaque
                chaveSelect.append(
                    $('<option>', {
                        value: 'nova',
                        text: '+ Cadastrar nova chave',
                    }).addClass('highlight-option') // Adiciona uma classe para personalização
                );

                // Lista de chaves
                data.forEach(chave => {
                    chaveSelect.append(
                        $('<option>', {
                            value: chave.id,
                            text: `${chave.cod} - ${chave.local || 'Sem local definido'}`,
                        })
                    );
                });

                chaveSelect.trigger('change');
            })
            .catch(error => console.error('Erro ao carregar as chaves:', error));
    }

    // Inicializa o Select2 com customização
    chaveSelect.select2({
        placeholder: 'Pesquise ou selecione',
        allowClear: true,
        templateResult: function (data) {
            // Aplica destaque à opção "nova"
            if (data.id === 'nova') {
                const $highlight = $('<span>').text(data.text).css({
                    color: 'green',
                    fontWeight: 'bold',
                });
                return $highlight;
            }
            return data.text;
        },
    });

    reloadChaveList();

    chaveSelect.on('change', function () {
        if (this.value === 'nova') {
            sidebarChave.style.display = 'block';
            chaveSelect.val(null).trigger('change');
        }
    });

    const chaveForm = sidebarChave.querySelector('form');
    chaveForm.addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(chaveForm);
        fetch(chaveForm.action, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (response.ok) {
                    sidebarChave.style.display = 'none';
                    reloadChaveList();
                    sidebarRegischave.style.display = 'block';
                } else {
                    throw new Error('Erro ao salvar a nova chave.');
                }
            })
            .catch(error => {
                console.error('Erro ao salvar a nova chave:', error);
                alert('Erro ao salvar a nova chave.');
            });
    });
});



// Sidebar Handlers
document.body.addEventListener('click', function(event) {
    const target = event.target;
    if (target.dataset.sidebar && target.dataset.display) {
        const sidebar = document.getElementById(target.dataset.sidebar);
        if (sidebar) {
            sidebar.style.display = target.dataset.display;
        }
    }
});

document.getElementById('close-saida-btn').addEventListener('click', function() {
    document.getElementById('sidebar-add-saida').style.display = 'none';
    currentVisitaId = null;
});

// Custom Alerts and Confirms
function customAlert(message) {
    const modal = document.getElementById('customAlert');
    const messageElement = document.getElementById('customAlertMessage');
    const okButton = document.getElementById('alertOk');
    messageElement.textContent = message;
    modal.style.display = 'flex';
    okButton.onclick = () => {
        modal.style.display = 'none';
        window.location.reload();
    };
}

function customConfirm(message) {
    return new Promise((resolve) => {
        const modal = document.getElementById('customConfirm');
        const messageElement = document.getElementById('customConfirmMessage');
        const yesButton = document.getElementById('confirmYes');
        const noButton = document.getElementById('confirmNo');
        messageElement.textContent = message;
        modal.style.display = 'flex';
        yesButton.onclick = () => {
            modal.style.display = 'none';
            resolve(true);
        };
        noButton.onclick = () => {
            modal.style.display = 'none';
            resolve(false);
        };
    });
}

// Delete Record
function deleteRecord(id) {
    customConfirm("Tem certeza de que deseja excluir este registro?")
        .then((confirmado) => {
            if (confirmado) {
                fetch(`/correios/${id}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.status === 204) {
                        location.reload();
                        customAlert("Registro excluído com sucesso.");
                    } else if (response.status === 404) {
                        customAlert("Registro não encontrado.");
                    } else {
                        customAlert("Ocorreu um erro ao excluir o registro.");
                    }
                })
                .catch(error => {
                    console.error("Erro ao excluir o registro:", error);
                });
            }
        });
}

// Update Records
function atualizarHorarioSaida() {
    const horarioSaida = document.getElementById("horarioSaida").value;
    if (!horarioSaida) {
        customAlert("Por favor, selecione um horário de saída.");
        return;
    }
    const Id = sessionStorage.getItem("Id");
    if (!Id) {
        customAlert("Erro: ID do estacionamento não encontrado.");
        return;
    }
    fetch(`/chave/atualizarSaida/${Id}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ hrSaida: horarioSaida }),
    })
        .then((response) => {
            if (response.ok) {
                customAlert("Horário de devolução atualizado com sucesso!");
            } else {
                return response.text().then((text) => {
                    throw new Error(text);
                });
            }
        })
        .catch((error) => {
            console.error("Erro ao atualizar o horário de devolução:", error);
            customAlert("Erro ao atualizar o horário de devolução.");
        });
}




// Populate Select Fields
async function populateSolicitantesSelect() {
    const solicitanteSelect = $('#solicitante');
    const sidebarFuncionario = document.getElementById('sidebar-funcionario');
    const sidebarRegischave = document.getElementById('sidebar-Regischave');
    const spinner = $('#loading');

    try {
        // Inicializa com um placeholder e a opção de adicionar novo solicitante
        solicitanteSelect.empty().append(
            $('<option>', {
                value: '',
                disabled: true,
                selected: true,
                text: 'Pesquise ou selecione um solicitante',
            })
        );

        solicitanteSelect.append(
            $('<option>', {
                value: 'novo',
                text: '+ Adicionar novo solicitante',
            }).addClass('highlight-option') 
        );

        // Carrega usuários da API
        const apiResponse = await fetch("/users/api/users");
        const apiUsers = await apiResponse.json();

        // Carrega usuários do banco de dados
        const dbResponse = await fetch("/funcionarios/listar");
        const dbUsers = await dbResponse.json();

        // Adiciona os usuários ao select
        apiUsers.forEach(user => {
            solicitanteSelect.append(
                $('<option>', {
                    value: user.officeLocation
                        ? `${user.displayName} - ${user.officeLocation}`
                        : user.displayName,
                    text: user.displayName,
                })
            );
        });

        dbUsers.forEach(funcionario => {
            solicitanteSelect.append(
                $('<option>', {
                    value: funcionario.id,
                    text: `${funcionario.name} - ${funcionario.setorNome?.toUpperCase() || 'SEM SETOR'}`
                })
            );
        });

        solicitanteSelect.select2({
    placeholder: 'Pesquise ou selecione',
    allowClear: true,
    templateResult: function (data) {
        // Verifica se o ID da opção é "novo"
        if (data.id === 'novo') {
            const $result = $('<span>').text(data.text).css({
                color: 'green',
                fontWeight: 'bold',
               
            });
            return $result;
        }
        return data.text; // Retorna o texto padrão para outras opções
    },
    templateSelection: function (data) {
        return data.text; // Renderiza o texto padrão para seleção
    },
});





        spinner.hide();
        solicitanteSelect.show();

        
        solicitanteSelect.on('change', function () {
            if (this.value === 'novo') {
                sidebarRegischave.style.display = 'none'; // Fecha o sidebar atual
                sidebarFuncionario.style.display = 'block'; // Abre o sidebar para cadastro de funcionário
                solicitanteSelect.val(null).trigger('change'); // Limpa a seleção
            }
        });

        // Lida com o envio do formulário de novo funcionário
        const funcionarioForm = sidebarFuncionario.querySelector('form');
        funcionarioForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const formData = new FormData(funcionarioForm);

            try {
                const response = await fetch(funcionarioForm.action, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    sidebarFuncionario.style.display = 'none'; // Fecha o sidebar de cadastro
                    populateSolicitantesSelect(); // Atualiza a lista de solicitantes
                    sidebarRegischave.style.display = 'block'; // Reabre o sidebar original
                } else {
                    throw new Error('Erro ao salvar o novo solicitante.');
                }
            } catch (error) {
                console.error('Erro ao salvar o novo solicitante:', error);
                alert('Erro ao salvar o novo solicitante.');
            }
        });
    } catch (error) {
        console.error('Erro ao carregar os dados de solicitantes:', error);
    }
}

// Chamada inicial para preencher o select ao carregar a página
document.addEventListener('DOMContentLoaded', populateSolicitantesSelect);

                    
 </script>
                    

	</body>
    
</html>  